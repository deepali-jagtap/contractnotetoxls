import imaplib
import email
from email.header import decode_header
import os

# Connect to the email server
imap = imaplib.IMAP4_SSL("imap.gmail.com")
email_address = "deepali.jagtap@gmail.com"
password = "psuz ggwn jros aaau"
imap.login(email_address, password)

# Select the mailbox you want to check
imap.select("inbox")

# Define the substring you're looking for
subject_substring = "Contract Note for Acc No 3794559"

# Search for emails with a certain subject
status, messages = imap.search(None, 'ALL')

# Fetch the email by ID
email_ids = messages[0].split()

for email_id in email_ids:
    res, msg = imap.fetch(email_id, "(RFC822)")
    for response_part in msg:
        subject = ""
        if isinstance(response_part, tuple):
            msg = email.message_from_bytes(response_part[1])
             # Decode the email subject
            subject, encoding = decode_header(msg["Subject"])[0]
            if isinstance(subject, bytes):
                subject = subject.decode(encoding if encoding else "utf-8")
                

            # Check if the subject contains the substring
            if subject_substring in subject:
                print(f"Found email with subject: {subject}")
                # You can now handle the email or download attachments
                for part in msg.walk():
                    if part.get_content_maintype() == 'multipart':
                        continue
                    if part.get('Content-Disposition') is None:
                        continue
                    filename = part.get_filename()
                    if filename:
                        with open(filename, 'wb') as f:
                            f.write(part.get_payload(decode=True))
                        print(f"Attachment {filename} downloaded.")
            else:
                print("Not containing substring: ",subject)
# Logout
imap.logout()

